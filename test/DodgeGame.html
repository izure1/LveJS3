<!DOCTYPE HTML>
<html>

<head>
  <title></title>
  <link rel="stylesheet" href="./css/common.css">
  <meta charset="utf-8">
  <script type="text/javascript" src="../dist/LveJS.js"></script>
</head>

<body>
  <canvas id="test" width="1200" height="850"></canvas>
  <script type="text/javascript">
    const gamename = 'LveJS_dodgeGame'
    const lve = new LveJS

    let highscore = getHighScore()
    let isGameover = false

    function getRandomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min
    }

    function createBall(i = 0) {

      let radius
      let r, g, b
      let x

      setTimeout(() => {

        x = getRandomInt(-600, 600)
        r = getRandomInt(0, 255)
        g = getRandomInt(0, 255)
        b = getRandomInt(0, 255)
        radius = getRandomInt(15, 20)

        i -= 1.5

        if (i < 100) {
          i = 100
        }

        lve(`ball_${getRandomInt(Number.MIN_SAFE_INTEGER, Number.MAX_SAFE_INTEGER)}`).create({
          type: 'circle'
        }).css({
          width: radius,
          height: radius,
          color: 'gray',
          left: x,
          bottom: 1000,
        }).attr({
          physics: 'dynamic',
          gravityscale: 0.2
        }).addClass('ball')

        createBall(i)

      }, i)

    }

    function updateScore() {

      lve.extendDrawEnd(function () {

        let score

        score = performance.now() / 10
        score = ~~score

        if (score > highscore) {
          highscore = score
          lve('highscore').attr('text', highscore)
        }

        lve('score').attr('text', score)

      })

    }

    function updateWind(interval) {

      lve.setGravity(getRandomInt(-7, 7), -9.8)

      setTimeout(() => {
        updateWind(interval)
      }, interval)

    }

    function updateGround(interval) {

      lve('ground').animate({
        rotate: getRandomInt(-25, 25)
      }, 1000)

      setTimeout(() => {
        updateGround(interval)
      }, interval)

    }

    function setHighScore(score) {
      localStorage.setItem(gamename, score)
    }

    function getHighScore() {
      return localStorage.getItem(gamename) || 0
    }

    function gameover() {

      if (isGameover) {
        return
      }

      isGameover = true

      lve('camera').animate({

        perspective: 50

      }, 3000, 'easeOutExpo').follow('character', {
        
        left: 0,
        bottom: 0

      })

      lve('character').css('color', 'red').animate({
        opacity: 0.3
      }, 3000, 'easeOutExpo')

      setTimeout(() => {

        let score

        score = lve('score').attr('text') - 0

        setHighScore(highscore)
        alert(`Game over!\n\nYour score is ${score}`)

        location.reload()

      }, 3000)

    }
  </script>
  <script>
    lve.init({
      canvas: '#test',
      backgroundColor: '#252525'
    })

    lve('camera').create({
      type: 'camera'
    }).css('bottom', 400).use()

    lve('ground').create({
      type: 'square'
    }).css({
      width: 1400,
      height: 25,
      color: '#A5F2F3',
      bottom: 50
    }).attr({
      physics: 'static',
      friction: 0.2
    })

    lve('deathline').create({
      type: 'square'
    }).css({
      width: Number.MAX_SAFE_INTEGER,
      height: 10000,
      bottom: -1000,
      verticalAlign: 'bottom'
    }).attr({
      physics: 'static'
    })

    lve('wall-left').create({
      type: 'square'
    }).css({
      width: 5,
      height: 1000,
      color: '#ddd',
      left: -600
    }).attr({
      physics: 'static',
      restitution: 1.2
    }).addClass('wall')

    lve('wall-right').create({
      type: 'square'
    }).css({
      width: 5,
      height: 1000,
      color: '#ddd',
      left: 600
    }).attr({
      physics: 'static',
      restitution: 1.2
    }).addClass('wall')

    lve('score').create({
      type: 'text',
      text: '0'
    }).css({
      fontSize: 40,
      fontWeight: 'bold',
      color: 'white',
      borderWidth: 10,
      borderColor: '#0075c8',
      left: 30,
      bottom: 800,
      position: 'fixed'
    })

    lve('highscore').create({
      type: 'text',
      text: highscore
    }).css({
      fontSize: 20,
      fontWeight: 'bold',
      color: 'white',
      borderWidth: 5,
      borderColor: 'red',
      left: 30,
      bottom: 750,
      position: 'fixed'
    })

    lve('character').create({
      type: 'square'
    }).css({
      width: 20,
      height: 50,
      color: 'white',
      bottom: 60,
    }).attr({
      physics: 'dynamic',
      friction: 1,
      density: 1,
      fixedrotation: true
    }).addClass('character')

    lve.on('contactstart', e => {

      if (e.target.name === 'character') {

        // ball hit
        if (e.another.hasClass('ball') && !e.another.hasClass('melting')) {
          gameover()
        }
        // dropped
        else if (e.another.name === 'deathline') {
          gameover()
        }

      }

      // melt ball
      else if (e.target.hasClass('ball')) {

        if (!e.another.hasClass('character')) {
          e.target.fadeOut(300)
          setTimeout(() => e.target.remove(), 300)
        }

      }

    })

    // Keyboard Controler
    window.onkeydown = function (e) {

      switch (e.keyCode) {

        case 37:
          lve('character').applyForce(-600, 0)
          break

        case 39:
          lve('character').applyForce(600, 0)
          break

      }

    }
  </script>
  <script>
    createBall(300)
    updateScore()
    updateWind(5000)
    updateGround(8000)
  </script>
</body>

</html>